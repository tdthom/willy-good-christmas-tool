<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Willy Good – Christmas Lights </title>
  <style>
        .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .company-logo {
      width: 80px;   /* try 80, you can change later */
      height: 80px;
      object-fit: contain;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #004b80;
      color: white;
      padding: 10px 16px;
    }
    nav {
      background: #eee;
      padding: 8px 16px;
      display: flex;
      gap: 8px;
    }
    nav button {
      padding: 6px 12px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    nav button.active {
      border-color: #004b80;
      font-weight: bold;
    }
    .screen {
      display: none;
      padding: 16px;
    }
    .screen.active {
      display: block;
    }
      .proposal-card {
      border: 1px solid #ccc;
      padding: 16px;
      margin-top: 16px;
      max-width: 650px;
      background: #fff;
    }
    .proposal-card-inner h3 {
      margin-top: 0.5rem;
    }
    .proposal-totals p {
      margin: 0.2rem 0;
    }

  </style>
     


</head>
<body>
   <header>
    <div class="header-left">
      <img src="logo.png" alt="Willy Good Christmas Lights" class="company-logo" />
      <div>
        <h1>Willy Good Christmas Lights Tool</h1>
        <p>One app, five screens: Clients • Estimate • Roof Measure • Photo Mockup • Proposal</p>
      </div>
    </div>
  </header>


  <nav>
    <button data-screen="clients" class="active">Clients</button>
    <button data-screen="estimate">Estimate</button>
    <button data-screen="roof">Roof Measure</button>
    <button data-screen="mockup">Photo Mockup</button>
    <button data-screen="proposal">Proposal</button>

  </nav>

    <!-- Screen 1: Clients -->
  <section id="screen-clients" class="screen active">
    <h2>Clients</h2>
    <p>Save basic client details and their preferred install date/week.</p>

    <h3>Add / update client</h3>

    <label for="client-name"><strong>Client name</strong></label><br />
    <input id="client-name" type="text" placeholder="e.g. John Smith" />
    <br /><br />

    <label for="client-phone"><strong>Phone</strong></label><br />
    <input id="client-phone" type="tel" placeholder="e.g. 555-123-4567" />
    <br /><br />

    <label for="client-email"><strong>Email</strong></label><br />
    <input id="client-email" type="email" placeholder="e.g. john@example.com" />
    <br /><br />

    <label for="client-address"><strong>Service address</strong></label><br />
    <textarea id="client-address" rows="3" placeholder="Street, city, ZIP"></textarea>
    <br /><br />

    <label for="client-preferred"><strong>Preferred install date/week</strong></label><br />
    <input id="client-preferred" type="text" placeholder="e.g. Week of Nov 25 or 2025-11-28" />
    <br /><br />

    <label for="client-notes"><strong>Notes</strong></label><br />
    <textarea id="client-notes" rows="3" placeholder="Gate code, roof access, special requests…"></textarea>
    <br /><br />
    
    <label for="client-rate"><strong>Default install rate ($/ft):</strong></label><br />
    <input id="client-rate" type="number" step="0.01" style="width:120px;" /><br /><br />

    <label for="client-takedown-rate"><strong>Default takedown rate ($/ft):</strong></label><br />
    <input id="client-takedown-rate" type="number" step="0.01" style="width:120px;" /><br /><br />

    <label for="client-lights-owned"><strong>Lights:</strong></label><br />
   <select id="client-lights-owned" style="width: 220px;">
   <option value="company">Company-owned lights</option>
   <option value="customer">Customer owns lights & stored</option>
   <option value="unknown">Not set</option>

    </select>
    <br /><br />


    <button id="save-client">Save client</button>

    <h3>Saved clients</h3>
    <ul id="clients-list">
      <!-- Filled in by script -->
    </ul>
  </section>

  <!-- Screen 2: Estimate -->
  <section id="screen-estimate" class="screen">
    <h2>Estimate</h2>
    <p>Enter your measurements below to get a quick price.</p>

    <div id="current-client-summary" style="margin-bottom: 1rem; font-size: 0.9rem;">
      <em>No client selected. Go to the Clients tab and click "Use for estimate".</em>
    </div>

  
    <h3>Feet of Lights</h3>

    <label for="ridge-feet"><strong>Main ridge</strong> (ft)</label><br />
    <input id="ridge-feet" type="number" min="0" step="1" placeholder="e.g. 80" /> ft
    <br /><br />

    <label for="hip-feet"><strong>Hip ridge</strong> (ft)</label><br />
    <input id="hip-feet" type="number" min="0" step="1" placeholder="e.g. 50" /> ft
    <br /><br />

    <label for="eaves-feet"><strong>Eaves / gutters</strong> (ft)</label><br />
    <input id="eaves-feet" type="number" min="0" step="1" placeholder="e.g. 20" /> ft
    <br /><br />

    <h3>Pricing</h3>

    <label for="rate-per-foot"><strong>Install price per foot</strong> you want to charge</label><br />
    <input id="rate-per-foot" type="number" min="0" step="0.01" value="4.00" /> $/ft
    <br /><br />

    <label for="takedown-rate"><strong>Takedown price per foot</strong></label><br />
    <input id="takedown-rate" type="number" min="0" step="0.01" value="2.00" /> $/ft
    <br /><br />

    <label for="tax-rate"><strong>Sales tax rate</strong> (%)</label><br />
    <input id="tax-rate" type="number" min="0" step="0.01" value="8.25" /> %
    <br /><br />

    <label for="container-cost"><strong>Container cost (internal only)</strong></label><br />
    <input id="container-cost" type="number" min="0" step="0.01" value="0.00" /> $
    <br /><br />

    <button id="calc-estimate">Calculate Estimate</button>

    <h3>Result</h3>
    <div id="estimate-result">
      Enter values and click "Calculate Estimate" to see the price.
    </div>
  </section>

  <!-- Screen 3: Roof Measure (top-down) -->
  <section id="screen-roof" class="screen">
    <h2>Roof Measure (Top View)</h2>
    <p>Use a satellite or drone screenshot to measure ridge, hip, and eaves from above.</p>

    <ol>
      <li>Upload a top-down screenshot of the roof.</li>
      <li>Click <strong>Set scale</strong> and draw a line of known length (e.g., 40 ft front width).</li>
      <li>Select run type (ridge / eaves / gable), click <strong>Measure</strong>, and trace the roof lines.</li>
    </ol>

    <input type="file" id="roof-image-input" accept="image/*" />
    <br /><br />

    <button id="roof-set-scale">1) Set scale</button>
    <label for="roof-scale-feet"><small>Known distance (ft):</small></label>
    <input id="roof-scale-feet" type="number" min="0" step="0.1" value="40" style="width:80px;" />
    <br /><br />

    <button id="roof-measure-mode">2) Measure runs</button>
    <button id="roof-undo">Undo last segment</button>
    <button id="roof-clear">Clear lines</button>
    <br /><br />

    <label for="roof-run-type"><strong>Run type:</strong></label>
    <select id="roof-run-type">
      <option value="ridge">Ridge / hip / shingle</option>
      <option value="eaves">Eaves / gutters</option>
      <option value="gable">Gable returns / other</option>
    </select>
    <br /><br />

    <button id="roof-zoom-in">Zoom in</button>
    <button id="roof-zoom-out">Zoom out</button>
    <button id="roof-send-to-estimate">Send ridge / eaves totals to Estimate</button>

    <div style="margin-top: 1rem;">
      <canvas
        id="roof-canvas"
        width="800"
        height="500"
        style="border:1px solid #ccc; max-width:100%; transform-origin: 0 0;"
      ></canvas>
    </div>

    <div id="roof-info" style="margin-top: 0.5rem; font-size: 0.9rem;">
      No image loaded.
    </div>

    <div id="roof-totals" style="margin-top: 0.5rem; font-size: 0.9rem;">
      <!-- totals appear here -->
    </div>
  </section>



     <!-- Screen 4: Photo Mockup -->
  <section id="screen-mockup" class="screen">
    <h2>Photo / Satellite Mockup</h2>
    <p>Upload a front photo or satellite screenshot, set a scale, and draw your light runs.</p>

    <ol>
      <li>Upload a screenshot (front photo or satellite view).</li>
      <li>Click <strong>Set scale</strong> and draw a line of known length (for example, a 40 ft wall).</li>
      <li>Select the run type (ridge / eaves / gable), click <strong>Measure runs</strong>, and click along the roof lines.</li>
    </ol>

    <input type="file" id="mockup-image-input" accept="image/*" />
    <br /><br />

    <button id="mockup-set-scale">1) Set scale</button>
    <label for="mockup-scale-feet"><small>Known distance (ft):</small></label>
    <input id="mockup-scale-feet" type="number" min="0" step="0.1" value="40" style="width:80px;" />
    <br /><br />

    <button id="mockup-measure-mode">2) Measure runs</button>
    <button id="mockup-undo">Undo last segment</button>
    <button id="mockup-clear">Clear lines</button>
    <br /><br />

    <label for="mockup-run-type"><strong>Current run type (for clips):</strong></label>
    <select id="mockup-run-type">
      <option value="ridge">Ridge / hip / shingle</option>
      <option value="eaves">Eaves / gutters</option>
      <option value="gable">Gable returns / other</option>
    </select>
    <br /><br />

    <strong>Color pattern:</strong>
    <select id="mockup-color-mode">
      <option value="single">Single color</option>
      <option value="two">2 colors (alternate)</option>
      <option value="three">3 colors (1-2-3 pattern)</option>
    </select>
    <br /><br />

    <label for="mockup-color1"><strong>Color 1:</strong></label>
    <input type="color" id="mockup-color1" value="#ffffff" />
    <label for="mockup-color2" style="margin-left:1rem;"><strong>Color 2:</strong></label>
    <input type="color" id="mockup-color2" value="#ff0000" />
    <label for="mockup-color3" style="margin-left:1rem;"><strong>Color 3:</strong></label>
    <input type="color" id="mockup-color3" value="#00ff00" />
    <br /><br />

    <label for="mockup-bulb-spacing"><strong>Bulb spacing:</strong></label>
    <select id="mockup-bulb-spacing">
      <option value="12">12" spacing</option>
      <option value="15">15" spacing</option>
    </select>
    <br /><br />

    <label for="mockup-bulb-size"><strong>Bulb size:</strong></label>
    <select id="mockup-bulb-size">
      <option value="small">Small</option>
      <option value="medium" selected>Medium</option>
      <option value="large">Large</option>
    </select>
    <br /><br />

    <label>
      <input type="checkbox" id="mockup-show-wire" checked />
      Show wire under bulbs (for editing only)
    </label>
    <br /><br />

    <button id="mockup-zoom-in">Zoom in</button>
    <button id="mockup-zoom-out">Zoom out</button>
    <button id="mockup-send-to-estimate">Send ridge / eaves totals to Estimate</button>





    <div style="margin-top: 1rem;">
      <canvas
        id="mockup-canvas"
        width="800"
        height="500"
        style="border:1px solid #ccc; max-width:100%; transform-origin: 0 0;"
      ></canvas>
    </div>

    <div id="mockup-info" style="margin-top: 0.5rem; font-size: 0.9rem;">
      No image loaded.
    </div>

    <div id="mockup-totals" style="margin-top: 0.5rem; font-size: 0.9rem;">
      <!-- length details will appear here -->
    </div>
  </section>



    <!-- Screen 5: Proposal -->
  <section id="screen-proposal" class="screen">
    <h2>Proposal</h2>
    <p>Preview what you can send to the client. Use your browser’s Print → “Save as PDF” to export.</p>

    <button id="refresh-proposal" style="margin-bottom: 0.5rem;">Refresh proposal</button>

    <div id="proposal-content" class="proposal-card">
      <em>No estimate found yet. Go to the Estimate tab, fill it out, and click "Calculate Estimate" first.</em>
            <div class="proposal-card-inner">
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
            <img src="logo.png" alt="Company logo" class="company-logo" />
            <div>
              <h3 style="margin:0;">Willy Good Christmas Lights</h3>
              <p style="margin:0; font-size:0.8rem;">Phone: 806.215.7047 • william@willygoodcleaning.com</p>
            </div>
          </div>
          <!-- existing proposal content continues here -->

  </section>


     <script>
    // -----------------------------
    // Navigation: switch between screens
    // -----------------------------
    const buttons = document.querySelectorAll("nav button");
    const screens = document.querySelectorAll(".screen");

    buttons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.screen;

        buttons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        screens.forEach((s) => {
          if (s.id === "screen-" + target) {
            s.classList.add("active");
          } else {
            s.classList.remove("active");
          }
        });
      });
    });

    // -----------------------------
    // Clients & estimate storage (localStorage)
    // -----------------------------
    const CLIENTS_KEY = "wgc-clients-v1";
    const CURRENT_CLIENT_KEY = "wgc-current-client-id";
    const ESTIMATE_KEY = "wgc-last-estimate-v1";

    function loadClients() {
      try {
        const raw = localStorage.getItem(CLIENTS_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.warn("Could not load clients", e);
        return [];
      }
    }

    function saveClients(clients) {
      try {
        localStorage.setItem(CLIENTS_KEY, JSON.stringify(clients));
      } catch (e) {
        console.warn("Could not save clients", e);
      }
    }

    function loadCurrentClientId() {
      try {
        const raw = localStorage.getItem(CURRENT_CLIENT_KEY);
        if (!raw) return null;
        const id = parseInt(raw, 10);
        return Number.isNaN(id) ? null : id;
      } catch {
        return null;
      }
    }

    function saveCurrentClientId(id) {
      try {
        if (id == null) {
          localStorage.removeItem(CURRENT_CLIENT_KEY);
        } else {
          localStorage.setItem(CURRENT_CLIENT_KEY, String(id));
        }
      } catch (e) {
        console.warn("Could not save current client id", e);
      }
    }

    function loadLastEstimate() {
      try {
        const raw = localStorage.getItem(ESTIMATE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch (e) {
        console.warn("Could not load last estimate", e);
        return null;
      }
    }

    function saveLastEstimate(data) {
      try {
        localStorage.setItem(ESTIMATE_KEY, JSON.stringify(data));
      } catch (e) {
        console.warn("Could not save last estimate", e);
      }
    }

        // -----------------------------
    // Clients UI
    // -----------------------------
    const clientNameInput = document.getElementById("client-name");
    const clientPhoneInput = document.getElementById("client-phone");
    const clientEmailInput = document.getElementById("client-email");
    const clientAddressInput = document.getElementById("client-address");
    const clientPreferredInput = document.getElementById("client-preferred");
    const clientNotesInput = document.getElementById("client-notes");
    const saveClientButton = document.getElementById("save-client");
    const clientsList = document.getElementById("clients-list");
    const currentClientSummaryDiv = document.getElementById("current-client-summary");
    const clientRateInput = document.getElementById("client-rate");
    const clientTakedownRateInput = document.getElementById("client-takedown-rate");
    const clientLightsOwnedSelect = document.getElementById("client-lights-owned");

    let clients = loadClients();
    let currentClientId = loadCurrentClientId();

    function getCurrentClient() {
      if (currentClientId == null) return null;
      return clients.find((c) => c.id === currentClientId) || null;
    }

    function updateCurrentClientSummary() {
      if (!currentClientSummaryDiv) return;
      const c = getCurrentClient();
      if (!c) {
        currentClientSummaryDiv.innerHTML =
          '<em>No client selected. Go to the Clients tab and click "Use for estimate".</em>';
      } else {
        currentClientSummaryDiv.innerHTML = `
          <strong>Current client:</strong> ${c.name}<br />
          ${c.address ? c.address + "<br />" : ""}
          ${c.phone ? "Phone: " + c.phone + "<br />" : ""}
          ${c.preferred ? "Preferred install: " + c.preferred : ""}
        `;
      }
    }

    function renderClientsList() {
      if (!clientsList) return;

      if (!clients.length) {
        clientsList.innerHTML = "<li>No clients saved yet.</li>";
        return;
      }

      clientsList.innerHTML = clients
        .map((c) => {
          const safeName = c.name || "(No name)";
          const safeAddress = c.address || "";
          const safePhone = c.phone || "-";
          const safeEmail = c.email || "-";
          const safePreferred = c.preferred || "-";
          const isCurrent = c.id === currentClientId;

          const rateInfo =
            c.defaultRate != null
              ? `Install: $${c.defaultRate.toFixed(2)}/ft; `
              : "";
          const tdInfo =
            c.defaultTakedown != null
              ? `Takedown: $${c.defaultTakedown.toFixed(2)}/ft; `
              : "";
          const lightsInfo =
            c.lightsOwned === "company"
              ? "Lights: company-owned"
              : c.lightsOwned === "customer"
              ? "Lights: customer-owned & stored"
              : "";

          const extraLine =
            rateInfo || tdInfo || lightsInfo
              ? `<small>${rateInfo}${tdInfo}${lightsInfo}</small><br />`
              : "";

          return `
            <li data-client-id="${c.id}">
              <strong>${safeName}</strong>${isCurrent ? " (current)" : ""}<br />
              ${safeAddress ? safeAddress + "<br />" : ""}
              Phone: ${safePhone} | Email: ${safeEmail}<br />
              Preferred install: ${safePreferred}<br />
              ${extraLine}
              <button class="use-client-button" data-client-id="${c.id}">
                Use for estimate
              </button>
            </li>
          `;
        })
        .join("");
    }

    if (saveClientButton) {
      saveClientButton.addEventListener("click", () => {
        if (!clientNameInput) {
          alert("Client form is not loaded correctly.");
          return;
        }

        const name = (clientNameInput.value || "").trim();
        if (!name) {
          alert("Client name is required.");
          return;
        }

        const phone = clientPhoneInput ? clientPhoneInput.value.trim() : "";
        const email = clientEmailInput ? clientEmailInput.value.trim() : "";
        const address = clientAddressInput ? clientAddressInput.value.trim() : "";
        const preferred = clientPreferredInput ? clientPreferredInput.value.trim() : "";
        const notes = clientNotesInput ? clientNotesInput.value.trim() : "";

        const defaultRate =
          clientRateInput && clientRateInput.value !== ""
            ? parseFloat(clientRateInput.value)
            : null;

        const defaultTakedown =
          clientTakedownRateInput && clientTakedownRateInput.value !== ""
            ? parseFloat(clientTakedownRateInput.value)
            : null;

        const lightsOwned = clientLightsOwnedSelect
          ? clientLightsOwnedSelect.value || "unknown"
          : "unknown";

        let client =
          typeof currentClientId === "number"
            ? clients.find((c) => c.id === currentClientId)
            : null;

        if (client) {
          // update existing
          client.name = name;
          client.phone = phone;
          client.email = email;
          client.address = address;
          client.preferred = preferred;
          client.notes = notes;
          client.defaultRate = defaultRate;
          client.defaultTakedown = defaultTakedown;
          client.lightsOwned = lightsOwned;
        } else {
          // create new
          client = {
            id: Date.now(),
            name,
            phone,
            email,
            address,
            preferred,
            notes,
            defaultRate,
            defaultTakedown,
            lightsOwned,
          };
          clients.push(client);
          currentClientId = client.id;
        }

        saveClients(clients);
        saveCurrentClientId(currentClientId);
        renderClientsList();
        updateCurrentClientSummary();
      });
    }

    if (clientsList) {
      clientsList.addEventListener("click", (event) => {
        const btn = event.target.closest(".use-client-button");
        if (!btn) return;

        const id = parseInt(btn.dataset.clientId, 10);
        if (Number.isNaN(id)) return;

        currentClientId = id;
        saveCurrentClientId(currentClientId);
        renderClientsList();
        updateCurrentClientSummary();

        const picked = clients.find((c) => c.id === currentClientId);
        if (picked) {
          // apply default install/takedown to Estimate tab if available
          if (typeof rateInput !== "undefined" && rateInput && picked.defaultRate != null) {
            rateInput.value = picked.defaultRate.toFixed(2);
          }
          if (
            typeof takedownRateInput !== "undefined" &&
            takedownRateInput &&
            picked.defaultTakedown != null
          ) {
            takedownRateInput.value = picked.defaultTakedown.toFixed(2);
          }
        }
      });
    }

    // Initial client render
    renderClientsList();
    updateCurrentClientSummary();


    // -----------------------------
    // Estimator logic: ridge + hip + eaves + takedown + tax
    // -----------------------------
    const ridgeInput = document.getElementById("ridge-feet");
    const hipInput = document.getElementById("hip-feet");
    const eavesInput = document.getElementById("eaves-feet");
    const rateInput = document.getElementById("rate-per-foot");
    const takedownRateInput = document.getElementById("takedown-rate");
    const taxRateInput = document.getElementById("tax-rate");
    const containerInput = document.getElementById("container-cost");
    const calcButton = document.getElementById("calc-estimate");
    const resultBox = document.getElementById("estimate-result");

    if (calcButton) {
      calcButton.addEventListener("click", () => {
        const ridge = parseFloat(ridgeInput.value) || 0;
        const hip = parseFloat(hipInput.value) || 0;
        const eaves = parseFloat(eavesInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const takedownRate = parseFloat(takedownRateInput.value) || 0;
        const taxRatePercent = parseFloat(taxRateInput.value) || 0;
        const container = parseFloat(containerInput.value) || 0;

        const totalFeet = ridge + hip + eaves;

        // Install prices
        const ridgePrice = ridge * rate;
        const hipPrice = hip * rate;
        const eavesPrice = eaves * rate;
        const installSubtotal = ridgePrice + hipPrice + eavesPrice;

        // Takedown
        const takedownSubtotal = totalFeet * takedownRate;

        // Customer subtotal before tax
        const customerSubtotal = installSubtotal + takedownSubtotal;

        // Tax
        const taxRate = taxRatePercent / 100;
        const taxAmount = customerSubtotal * taxRate;
        const customerTotalWithTax = customerSubtotal + taxAmount;

        // Internal total (pre-tax) including container
        const internalTotal = customerSubtotal + container;

        // Save last estimate snapshot (for proposal)
        const currentClient = getCurrentClient();
        const estimateSnapshot = {
          timestamp: new Date().toISOString(),
          totalFeet,
          ridge,
          hip,
          eaves,
          rate,
          takedownRate,
          taxRatePercent,
          installSubtotal,
          takedownSubtotal,
          customerSubtotal,
          taxAmount,
          customerTotalWithTax,
          client: currentClient
            ? {
                name: currentClient.name,
                address: currentClient.address,
                phone: currentClient.phone,
                email: currentClient.email,
                preferred: currentClient.preferred,
              }
            : null,
        };
        saveLastEstimate(estimateSnapshot);

        resultBox.innerHTML = `
          <p><strong>Total feet:</strong> ${totalFeet.toFixed(0)} ft</p>
          <p><strong>Main ridge:</strong> ${ridge.toFixed(0)} ft → $${ridgePrice.toFixed(2)}</p>
          <p><strong>Hip ridge:</strong> ${hip.toFixed(0)} ft → $${hipPrice.toFixed(2)}</p>
          <p><strong>Eaves / gutters:</strong> ${eaves.toFixed(0)} ft → $${eavesPrice.toFixed(2)}</p>
          <hr />
          <p><strong>Install subtotal:</strong> $${installSubtotal.toFixed(2)}</p>
          <p><strong>Takedown subtotal:</strong> $${takedownSubtotal.toFixed(2)}</p>
          <p><strong>Customer subtotal (install + takedown, before tax):</strong> $${customerSubtotal.toFixed(2)}</p>
          <p><strong>Sales tax (${taxRatePercent.toFixed(2)}%):</strong> $${taxAmount.toFixed(2)}</p>
          <p><strong>Customer total (with tax):</strong> $${customerTotalWithTax.toFixed(2)}</p>
          <br />
          <p><strong>Internal container cost (not shown on proposal):</strong> $${container.toFixed(2)}</p>
          <p><strong>Internal total (install + takedown + container, pre-tax):</strong> $${internalTotal.toFixed(2)}</p>
        `;
      });
    }

    // -----------------------------
    // Proposal rendering
    // -----------------------------
    const proposalContent = document.getElementById("proposal-content");
    const refreshProposalButton = document.getElementById("refresh-proposal");

    function renderProposal() {
      if (!proposalContent) return;
      const est = loadLastEstimate();

      if (!est) {
        proposalContent.innerHTML =
          '<em>No estimate found yet. Go to the Estimate tab, fill it out, and click "Calculate Estimate" first.</em>';
        return;
      }

      const client = est.client || getCurrentClient();
      const dateStr = est.timestamp
        ? new Date(est.timestamp).toLocaleDateString()
        : "";

      let clientHtml = "";
      if (client) {
        clientHtml = `
          <div class="proposal-header">
            <strong>${client.name || ""}</strong><br />
            ${client.address ? client.address + "<br />" : ""}
            ${client.phone ? "Phone: " + client.phone + "<br />" : ""}
            ${client.email ? "Email: " + client.email + "<br />" : ""}
            ${client.preferred ? "Preferred install: " + client.preferred + "<br />" : ""}
          </div>
        `;
      } else {
        clientHtml = "<p><em>No client selected.</em></p>";
      }

      proposalContent.innerHTML = `
        <div class="proposal-card-inner">
          <p><strong>Proposal date:</strong> ${dateStr}</p>
          ${clientHtml}
          <h3>Christmas Light Installation & Takedown</h3>
          <p><strong>Total feet:</strong> ${est.totalFeet.toFixed(0)} ft (ridge, hip, eaves)</p>
          <ul>
            <li>Install: $${est.installSubtotal.toFixed(2)} (@ $${est.rate.toFixed(2)}/ft)</li>
            <li>Takedown: $${est.takedownSubtotal.toFixed(2)} (@ $${est.takedownRate.toFixed(2)}/ft)</li>
          </ul>
          <div class="proposal-totals">
            <p>Subtotal (install + takedown): $${est.customerSubtotal.toFixed(2)}</p>
            <p>Sales tax (${est.taxRatePercent.toFixed(2)}%): $${est.taxAmount.toFixed(2)}</p>
            <p><strong>Total investment: $${est.customerTotalWithTax.toFixed(2)}</strong></p>
          </div>
          <p style="font-size:0.85rem;margin-top:1rem;">
            This proposal includes professional installation, season-long use, and scheduled takedown of lights.
          </p>
        </div>
      `;
    }

    if (refreshProposalButton) {
      refreshProposalButton.addEventListener("click", renderProposal);
    }

    // Initial proposal render on page load
    renderProposal();
    // -----------------------------
    // Roof Measure (top-down) screen
    // -----------------------------
    const roofImageInput = document.getElementById("roof-image-input");
    const roofSetScaleBtn = document.getElementById("roof-set-scale");
    const roofMeasureBtn = document.getElementById("roof-measure-mode");
    const roofUndoBtn = document.getElementById("roof-undo");
    const roofClearBtn = document.getElementById("roof-clear");
    const roofZoomInBtn = document.getElementById("roof-zoom-in");
    const roofZoomOutBtn = document.getElementById("roof-zoom-out");
    const roofSendToEstimateBtn = document.getElementById("roof-send-to-estimate");
    const roofScaleFeetInput = document.getElementById("roof-scale-feet");
    const roofRunTypeSelect = document.getElementById("roof-run-type");
    const roofCanvas = document.getElementById("roof-canvas");
    const roofInfo = document.getElementById("roof-info");
    const roofTotals = document.getElementById("roof-totals");
    const roofCtx = roofCanvas ? roofCanvas.getContext("2d") : null;

    let roofImage = null;
    let roofMode = "none"; // "scale" or "measure"
    let roofScalePoints = [];
    let roofSegments = []; // {from, to, feet, type}
    let roofFeetPerPixel = null;
    let roofDrawParams = null;
    let roofZoom = 1;

    function roofSetInfo(text) {
      if (roofInfo) roofInfo.textContent = text;
    }

    function roofApplyZoom() {
      if (!roofCanvas) return;
      roofCanvas.style.transform = `scale(${roofZoom})`;
    }

    function roofDrawBase() {
      if (!roofCtx || !roofCanvas) return;
      roofCtx.clearRect(0, 0, roofCanvas.width, roofCanvas.height);
      if (roofImage && roofDrawParams) {
        roofCtx.drawImage(
          roofImage,
          roofDrawParams.x,
          roofDrawParams.y,
          roofDrawParams.w,
          roofDrawParams.h
        );
      }
    }

    function roofPixelDist(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function roofRedraw() {
      if (!roofCtx || !roofCanvas) return;
      roofDrawBase();

      // scale line
      if (roofScalePoints.length === 2) {
        roofCtx.strokeStyle = "#ffa500";
        roofCtx.lineWidth = 2;
        roofCtx.beginPath();
        roofCtx.moveTo(roofScalePoints[0].x, roofScalePoints[0].y);
        roofCtx.lineTo(roofScalePoints[1].x, roofScalePoints[1].y);
        roofCtx.stroke();
      }

      // segments by type
      roofSegments.forEach((seg) => {
        let color = "#ff0000";
        if (seg.type === "eaves") color = "#0000ff";
        else if (seg.type === "gable") color = "#008000";

        roofCtx.beginPath();
        roofCtx.strokeStyle = color;
        roofCtx.lineWidth = 3;
        roofCtx.moveTo(seg.from.x, seg.from.y);
        roofCtx.lineTo(seg.to.x, seg.to.y);
        roofCtx.stroke();
      });
    }

    function roofUpdateTotals() {
      if (!roofTotals) return;
      if (!roofImage) {
        roofTotals.innerHTML = "";
        return;
      }

      const totals = { ridge: 0, eaves: 0, gable: 0 };
      roofSegments.forEach((seg) => {
        if (totals[seg.type] != null) totals[seg.type] += seg.feet || 0;
      });

      const all = totals.ridge + totals.eaves + totals.gable;

      let html = "";
      if (roofFeetPerPixel) {
        html += `<p>Scale: 1 pixel ≈ ${roofFeetPerPixel.toFixed(4)} ft</p>`;
      } else {
        html += "<p>No scale set yet.</p>";
      }
      html += "<ul>";
      html += `<li><strong>Ridge / hip / shingle:</strong> ${totals.ridge.toFixed(1)} ft</li>`;
      html += `<li><strong>Eaves / gutters:</strong> ${totals.eaves.toFixed(1)} ft</li>`;
      html += `<li><strong>Gable returns / other:</strong> ${totals.gable.toFixed(1)} ft</li>`;
      html += "</ul>";
      html += `<p><strong>Total measured length (all types):</strong> ${all.toFixed(
        1
      )} ft</p>`;

      roofTotals.innerHTML = html;
    }

    function roofCanvasPoint(evt) {
      const rect = roofCanvas.getBoundingClientRect();
      return {
        x: (evt.clientX - rect.left) / roofZoom,
        y: (evt.clientY - rect.top) / roofZoom,
      };
    }

    // Image upload
    if (roofImageInput && roofCtx && roofCanvas) {
      roofImageInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            roofImage = img;
            const cw = roofCanvas.width;
            const ch = roofCanvas.height;
            const imgAspect = img.width / img.height;
            const canvasAspect = cw / ch;
            let w, h, ox, oy;
            if (imgAspect > canvasAspect) {
              w = cw;
              h = cw / imgAspect;
              ox = 0;
              oy = (ch - h) / 2;
            } else {
              h = ch;
              w = ch * imgAspect;
              ox = (cw - w) / 2;
              oy = 0;
            }
            roofDrawParams = { x: ox, y: oy, w, h };
            roofScalePoints = [];
            roofSegments = [];
            roofFeetPerPixel = null;
            roofMode = "none";
            roofZoom = 1;
            roofApplyZoom();
            roofDrawBase();
            roofSetInfo("Image loaded. Step 1: set scale.");
            roofUpdateTotals();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Set scale
    if (roofSetScaleBtn) {
      roofSetScaleBtn.addEventListener("click", () => {
        if (!roofImage) {
          roofSetInfo("Upload an image first.");
          return;
        }
        roofMode = "scale";
        roofScalePoints = [];
        roofSegments = [];
        roofFeetPerPixel = null;
        roofRedraw();
        roofSetInfo("Scale mode: click two points on a known distance.");
        roofUpdateTotals();
      });
    }

    // Measure mode
    if (roofMeasureBtn) {
      roofMeasureBtn.addEventListener("click", () => {
        if (!roofImage) {
          roofSetInfo("Upload an image first.");
          return;
        }
        if (!roofFeetPerPixel) {
          roofSetInfo("Set scale first, then measure.");
          return;
        }
        roofMode = "measure";
        roofRedraw();
        roofSetInfo("Measure mode: pick run type and click along each run.");
      });
    }

    // Zoom buttons
    if (roofZoomInBtn) {
      roofZoomInBtn.addEventListener("click", () => {
        roofZoom = Math.min(roofZoom + 0.25, 4);
        roofApplyZoom();
      });
    }
    if (roofZoomOutBtn) {
      roofZoomOutBtn.addEventListener("click", () => {
        roofZoom = Math.max(roofZoom - 0.25, 0.5);
        roofApplyZoom();
      });
    }

    // Clear & undo
    if (roofClearBtn) {
      roofClearBtn.addEventListener("click", () => {
        roofScalePoints = [];
        roofSegments = [];
        roofFeetPerPixel = null;
        roofMode = "none";
        roofRedraw();
        roofSetInfo("Cleared. Set scale again if needed.");
        roofUpdateTotals();
      });
    }
    if (roofUndoBtn) {
      roofUndoBtn.addEventListener("click", () => {
        if (roofSegments.length > 0) {
          roofSegments.pop();
          roofRedraw();
          roofUpdateTotals();
        }
      });
    }

    // Send to Estimate
    if (roofSendToEstimateBtn) {
      roofSendToEstimateBtn.addEventListener("click", () => {
        if (!roofFeetPerPixel || roofSegments.length === 0) {
          alert("Measure roof runs first.");
          return;
        }
        const totals = { ridge: 0, eaves: 0, gable: 0 };
        roofSegments.forEach((seg) => {
          if (totals[seg.type] != null) totals[seg.type] += seg.feet || 0;
        });
        if (ridgeInput) ridgeInput.value = totals.ridge.toFixed(1);
        if (eavesInput) eavesInput.value = totals.eaves.toFixed(1);
        roofSetInfo(
          `Sent to Estimate: ridge ${totals.ridge.toFixed(
            1
          )} ft, eaves ${totals.eaves.toFixed(1)} ft.`
        );
      });
    }

    // Canvas clicks
    if (roofCanvas && roofCtx) {
      let lastPoint = null;
      roofCanvas.addEventListener("click", (evt) => {
        if (!roofImage) return;
        const pt = roofCanvasPoint(evt);

        if (roofMode === "scale") {
          roofScalePoints.push(pt);
          if (roofScalePoints.length > 2) roofScalePoints = [pt];
          if (roofScalePoints.length === 2) {
            const pixels = roofPixelDist(roofScalePoints[0], roofScalePoints[1]);
            const feet = parseFloat(roofScaleFeetInput.value) || 0;
            if (feet > 0 && pixels > 0) {
              roofFeetPerPixel = feet / pixels;
              roofSetInfo(
                `Scale set: ${feet.toFixed(1)} ft = ${pixels.toFixed(
                  1
                )} px.`
              );
            } else {
              roofFeetPerPixel = null;
              roofSetInfo("Enter a positive known distance and click again.");
            }
          }
          roofRedraw();
          roofUpdateTotals();
        } else if (roofMode === "measure") {
          if (!roofFeetPerPixel) {
            roofSetInfo("Set scale first.");
            return;
          }
          const type = roofRunTypeSelect ? roofRunTypeSelect.value : "ridge";
          if (!lastPoint) {
            lastPoint = pt;
          } else {
            const pixels = roofPixelDist(lastPoint, pt);
            const feet = pixels * roofFeetPerPixel;
            roofSegments.push({
              from: lastPoint,
              to: pt,
              feet,
              type,
            });
            lastPoint = pt;
          }
          roofRedraw();
          roofUpdateTotals();
        }
      });
      roofApplyZoom();
    }

     // -----------------------------
    // Photo / Satellite mockup measurement
    // -----------------------------
    const mockupImageInput = document.getElementById("mockup-image-input");
    const mockupSetScaleBtn = document.getElementById("mockup-set-scale");
    const mockupMeasureBtn = document.getElementById("mockup-measure-mode");
    const mockupUndoBtn = document.getElementById("mockup-undo");
    const mockupClearBtn = document.getElementById("mockup-clear");
    const mockupZoomInBtn = document.getElementById("mockup-zoom-in");
    const mockupZoomOutBtn = document.getElementById("mockup-zoom-out");
    const mockupSendToEstimateBtn = document.getElementById("mockup-send-to-estimate");
    const mockupScaleFeetInput = document.getElementById("mockup-scale-feet");
    const mockupRunTypeSelect = document.getElementById("mockup-run-type");
    const mockupColorModeSelect = document.getElementById("mockup-color-mode");
    const mockupColor1Input = document.getElementById("mockup-color1");
    const mockupColor2Input = document.getElementById("mockup-color2");
    const mockupColor3Input = document.getElementById("mockup-color3");
    const mockupBulbSpacingSelect = document.getElementById("mockup-bulb-spacing");
    const mockupBulbSizeSelect = document.getElementById("mockup-bulb-size");
    const mockupShowWireCheckbox = document.getElementById("mockup-show-wire");
    const mockupCanvas = document.getElementById("mockup-canvas");
    const mockupInfo = document.getElementById("mockup-info");
    const mockupTotals = document.getElementById("mockup-totals");
    const mockupCtx = mockupCanvas ? mockupCanvas.getContext("2d") : null;

    let mockupImage = null;
    let mockupMode = "none"; // "scale" or "measure"
    let scalePoints = [];
    let runSegments = []; // {from, to, feet, type}
    let feetPerPixel = null;
    let drawImageParams = null;
    let mockupZoom = 1;
    const MOCKUP_MIN_ZOOM = 0.5;
    const MOCKUP_MAX_ZOOM = 4;

    const typeColors = {
      ridge: "red",
      eaves: "blue",
      gable: "green",
    };

    function mockupSetInfo(text) {
      if (mockupInfo) {
        mockupInfo.textContent = text;
      }
    }

    function applyMockupZoom() {
      if (!mockupCanvas) return;
      mockupCanvas.style.transform = `scale(${mockupZoom})`;
    }

    function drawMockupBase() {
      if (!mockupCtx || !mockupCanvas) return;
      mockupCtx.clearRect(0, 0, mockupCanvas.width, mockupCanvas.height);
      if (mockupImage && drawImageParams) {
        mockupCtx.drawImage(
          mockupImage,
          drawImageParams.x,
          drawImageParams.y,
          drawImageParams.w,
          drawImageParams.h
        );
      }
    }

    function pixelDistance(p1, p2) {
      const dx = p1.x - p2.x;
      const dy = p1.y - p2.y;
      return Math.sqrt(dx * dx + dy * dy);
    }

    function redrawMockup() {
      if (!mockupCtx || !mockupCanvas) return;
      drawMockupBase();

      // draw scale line
      if (scalePoints.length === 2) {
        mockupCtx.strokeStyle = "#ffa500"; // orange
        mockupCtx.lineWidth = 2;
        mockupCtx.beginPath();
        mockupCtx.moveTo(scalePoints[0].x, scalePoints[0].y);
        mockupCtx.lineTo(scalePoints[1].x, scalePoints[1].y);
        mockupCtx.stroke();
      }

      // draw measured runs – teardrop bulbs with color patterns
      runSegments.forEach((seg) => {
        const dx = seg.to.x - seg.from.x;
        const dy = seg.to.y - seg.from.y;
        const lengthPx = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx);

        // Show or hide the wire under bulbs
        if (!mockupShowWireCheckbox || mockupShowWireCheckbox.checked) {
          mockupCtx.beginPath();
          mockupCtx.strokeStyle = "#555";
          mockupCtx.lineWidth = 1;
          mockupCtx.moveTo(seg.from.x, seg.from.y);
          mockupCtx.lineTo(seg.to.x, seg.to.y);
          mockupCtx.stroke();
        }

        // Spacing: 12" / 15"
        let spacingInches = 12;
        if (mockupBulbSpacingSelect) {
          const val = parseFloat(mockupBulbSpacingSelect.value);
          if (!Number.isNaN(val) && val > 0) spacingInches = val;
        }
        let spacingPx;
        if (feetPerPixel) {
          const spacingFt = spacingInches / 12;
          spacingPx = spacingFt / feetPerPixel;
        } else {
          spacingPx = 22; // visual default
        }
        spacingPx = Math.min(Math.max(spacingPx, 8), 50);

        // Bulb size small/medium/large
        let baseSize = 3.0;
        if (mockupBulbSizeSelect) {
          const sizeVal = mockupBulbSizeSelect.value;
          if (sizeVal === "small") baseSize = 2.2;
          else if (sizeVal === "large") baseSize = 4.0;
        }
        const bulbHeight = baseSize * 2.4;
        const glowRadius = bulbHeight * 0.9;

        // Color pattern: single / two / three
        const mode = mockupColorModeSelect
          ? mockupColorModeSelect.value
          : "single";
        const c1 =
          (mockupColor1Input && mockupColor1Input.value) || "#ffffff";
        const c2 =
          (mockupColor2Input && mockupColor2Input.value) || "#ff0000";
        const c3 =
          (mockupColor3Input && mockupColor3Input.value) || "#00ff00";

        const count = Math.max(1, Math.round(lengthPx / spacingPx));
        for (let i = 0; i <= count; i++) {
          const t = count === 0 ? 0 : i / count;
          const x = seg.from.x + dx * t;
          const y = seg.from.y + dy * t;

          let color = c1;
          if (mode === "two") {
            color = i % 2 === 0 ? c1 : c2;
          } else if (mode === "three") {
            const idx = i % 3;
            color = idx === 0 ? c1 : idx === 1 ? c2 : c3;
          }

          mockupCtx.save();
          mockupCtx.translate(x, y);
          mockupCtx.rotate(angle);

          // soft glow
          mockupCtx.beginPath();
          mockupCtx.globalAlpha = 0.22;
          mockupCtx.fillStyle = color;
          mockupCtx.arc(0, 0, glowRadius, 0, Math.PI * 2);
          mockupCtx.fill();
          mockupCtx.globalAlpha = 1;

          // teardrop bulb
          mockupCtx.beginPath();
          mockupCtx.moveTo(0, -bulbHeight / 2); // tip
          mockupCtx.quadraticCurveTo(
            baseSize,
            0,
            0,
            bulbHeight / 2
          );
          mockupCtx.quadraticCurveTo(
            -baseSize,
            0,
            0,
            -bulbHeight / 2
          );
          mockupCtx.closePath();
          mockupCtx.fillStyle = color;
          mockupCtx.strokeStyle = "#f5f5f5";
          mockupCtx.lineWidth = 0.8;
          mockupCtx.fill();
          mockupCtx.stroke();

          // small socket
          mockupCtx.fillStyle = "#444";
          mockupCtx.fillRect(
            -baseSize * 0.6,
            bulbHeight / 2,
            baseSize * 1.2,
            baseSize * 0.6
          );

          mockupCtx.restore();
        }
      });



    }

    function updateMockupTotals() {
      if (!mockupTotals) return;
      if (!mockupImage) {
        mockupTotals.innerHTML = "";
        return;
      }

      let html = "";
      if (feetPerPixel) {
        html += `<p>Scale: 1 pixel ≈ ${feetPerPixel.toFixed(4)} ft</p>`;
      } else {
        html += "<p>No scale set yet.</p>";
      }

      if (runSegments.length === 0) {
        html += "<p>No measured runs yet.</p>";
        mockupTotals.innerHTML = html;
        return;
      }

      const totalsByType = {
        ridge: 0,
        eaves: 0,
        gable: 0,
      };

      runSegments.forEach((seg) => {
        if (totalsByType[seg.type] != null) {
          totalsByType[seg.type] += seg.feet;
        }
      });

      let grandTotal = 0;
      grandTotal += totalsByType.ridge;
      grandTotal += totalsByType.eaves;
      grandTotal += totalsByType.gable;

      html += "<ul>";
      if (totalsByType.ridge > 0) {
        html += `<li><strong>Ridge / hip / shingle:</strong> ${totalsByType.ridge.toFixed(
          1
        )} ft</li>`;
      }
      if (totalsByType.eaves > 0) {
        html += `<li><strong>Eaves / gutters:</strong> ${totalsByType.eaves.toFixed(
          1
        )} ft</li>`;
      }
      if (totalsByType.gable > 0) {
        html += `<li><strong>Gable returns / other:</strong> ${totalsByType.gable.toFixed(
          1
        )} ft</li>`;
      }
      html += "</ul>";
      html += `<p><strong>Total measured length (all types):</strong> ${grandTotal.toFixed(
        1
      )} ft</p>`;

      mockupTotals.innerHTML = html;
    }

    function getCanvasPointFromEvent(event) {
      const rect = mockupCanvas.getBoundingClientRect();
      const xScreen = event.clientX - rect.left;
      const yScreen = event.clientY - rect.top;
      const x = xScreen / mockupZoom;
      const y = yScreen / mockupZoom;
      return { x, y };
    }

    // Image loading
    if (mockupImageInput && mockupCtx && mockupCanvas) {
      mockupImageInput.addEventListener("change", (event) => {
        const file = event.target.files && event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            mockupImage = img;
            const canvasWidth = mockupCanvas.width;
            const canvasHeight = mockupCanvas.height;
            const imgAspect = img.width / img.height;
            const canvasAspect = canvasWidth / canvasHeight;
            let drawWidth, drawHeight, offsetX, offsetY;
            if (imgAspect > canvasAspect) {
              drawWidth = canvasWidth;
              drawHeight = canvasWidth / imgAspect;
              offsetX = 0;
              offsetY = (canvasHeight - drawHeight) / 2;
            } else {
              drawHeight = canvasHeight;
              drawWidth = canvasHeight * imgAspect;
              offsetX = (canvasWidth - drawWidth) / 2;
              offsetY = 0;
            }
            drawImageParams = {
              x: offsetX,
              y: offsetY,
              w: drawWidth,
              h: drawHeight,
            };

            scalePoints = [];
            runSegments = [];
            feetPerPixel = null;
            mockupMode = "none";
            mockupZoom = 1;
            applyMockupZoom();

            drawMockupBase();
            mockupSetInfo(
              "Image loaded. Step 1: click 'Set scale' and draw a line of known length."
            );
            updateMockupTotals();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Set scale mode
    if (mockupSetScaleBtn) {
      mockupSetScaleBtn.addEventListener("click", () => {
        if (!mockupImage) {
          mockupSetInfo("Upload an image first.");
          return;
        }
        mockupMode = "scale";
        scalePoints = [];
        runSegments = [];
        feetPerPixel = null;
        redrawMockup();
        mockupSetInfo(
          "Scale mode: click two points on a known distance (e.g., 40 ft front width)."
        );
        updateMockupTotals();
      });
    }

    // Measure mode
    if (mockupMeasureBtn) {
      mockupMeasureBtn.addEventListener("click", () => {
        if (!mockupImage) {
          mockupSetInfo("Upload an image first.");
          return;
        }
        if (!feetPerPixel) {
          mockupSetInfo("Set the scale first, then measure runs.");
          return;
        }
        mockupMode = "measure";
        redrawMockup();
        mockupSetInfo(
          "Measure mode: choose run type, then click along each run; each segment will be measured."
        );
        updateMockupTotals();
      });
    }

    // Zoom buttons
    if (mockupZoomInBtn) {
      mockupZoomInBtn.addEventListener("click", () => {
        mockupZoom = Math.min(mockupZoom + 0.25, MOCKUP_MAX_ZOOM);
        applyMockupZoom();
      });
    }
    if (mockupZoomOutBtn) {
      mockupZoomOutBtn.addEventListener("click", () => {
        mockupZoom = Math.max(mockupZoom - 0.25, MOCKUP_MIN_ZOOM);
        applyMockupZoom();
      });
    }

    // Clear all lines
    if (mockupClearBtn) {
      mockupClearBtn.addEventListener("click", () => {
        if (!mockupImage) {
          scalePoints = [];
          runSegments = [];
          feetPerPixel = null;
          drawMockupBase();
          mockupSetInfo("No image loaded.");
          updateMockupTotals();
          return;
        }
        scalePoints = [];
        runSegments = [];
        feetPerPixel = null;
        mockupMode = "none";
        redrawMockup();
        mockupSetInfo("Cleared lines. Set scale again if needed.");
        updateMockupTotals();
      });
    }

    // Undo last segment
    if (mockupUndoBtn) {
      mockupUndoBtn.addEventListener("click", () => {
        if (runSegments.length > 0) {
          runSegments.pop();
          redrawMockup();
          updateMockupTotals();
        }
      });
    }
    

     // Re-draw when colors / pattern / spacing / size change
    if (mockupColorModeSelect) {
      mockupColorModeSelect.addEventListener("change", redrawMockup);
    }
    if (mockupColor1Input) {
      mockupColor1Input.addEventListener("change", redrawMockup);
    }
    if (mockupColor2Input) {
      mockupColor2Input.addEventListener("change", redrawMockup);
    }
    if (mockupColor3Input) {
      mockupColor3Input.addEventListener("change", redrawMockup);
    }
    if (mockupBulbSpacingSelect) {
      mockupBulbSpacingSelect.addEventListener("change", redrawMockup);
    }
    if (mockupBulbSizeSelect) {
      mockupBulbSizeSelect.addEventListener("change", redrawMockup);
    }
    if (mockupShowWireCheckbox) {
      mockupShowWireCheckbox.addEventListener("change", redrawMockup);
    }


    // Send measured ridge/eaves totals into the Estimate tab
    if (mockupSendToEstimateBtn) {
      mockupSendToEstimateBtn.addEventListener("click", () => {
        if (!feetPerPixel || runSegments.length === 0) {
          alert("Measure your runs first before sending to Estimate.");
          return;
        }

        const totalsByType = { ridge: 0, eaves: 0, gable: 0 };
        runSegments.forEach((seg) => {
          if (totalsByType[seg.type] != null) {
            totalsByType[seg.type] += seg.feet;
          }
        });

        // Fill Estimate fields (ridge = ridge/hip total, eaves = eaves total)
        if (ridgeInput) {
          ridgeInput.value = totalsByType.ridge.toFixed(1); // ridge + hip combined
        }
        if (eavesInput) {
          eavesInput.value = totalsByType.eaves.toFixed(1);
        }

        mockupSetInfo(
          `Sent measured totals to Estimate: ridge=${totalsByType.ridge.toFixed(
            1
          )} ft, eaves=${totalsByType.eaves.toFixed(1)} ft. You can still adjust by hand.`
        );
      });
    }
    // Send measured ridge/eaves totals into the Estimate tab
    if (mockupSendToEstimateBtn) {
      mockupSendToEstimateBtn.addEventListener("click", () => {
        if (!feetPerPixel || runSegments.length === 0) {
          alert("For Estimate: set your scale and measure runs first (on a top-down/satellite image).");
          return;
        }

        const totalsByType = { ridge: 0, eaves: 0, gable: 0 };
        runSegments.forEach((seg) => {
          if (totalsByType[seg.type] != null) {
            totalsByType[seg.type] += seg.feet;
          }
        });

        if (ridgeInput) {
          ridgeInput.value = totalsByType.ridge.toFixed(1);
        }
        if (eavesInput) {
          eavesInput.value = totalsByType.eaves.toFixed(1);
        }

        mockupSetInfo(
          `Sent to Estimate: ridge ${totalsByType.ridge.toFixed(
            1
          )} ft, eaves ${totalsByType.eaves.toFixed(1)} ft. You can still adjust those fields by hand.`
        );
      });
    }

    // Canvas click handling (scale + measure)
    if (mockupCanvas && mockupCtx) {
      let lastMeasurePoint = null;

      mockupCanvas.addEventListener("click", (event) => {
        if (!mockupImage) return;

        const point = getCanvasPointFromEvent(event);

        if (mockupMode === "scale") {
          scalePoints.push(point);
          if (scalePoints.length > 2) {
            scalePoints = [point];
          }
          if (scalePoints.length === 2) {
            const pixels = pixelDistance(scalePoints[0], scalePoints[1]);
            const feet = parseFloat(mockupScaleFeetInput.value) || 0;
            if (feet <= 0 || pixels === 0) {
              feetPerPixel = null;
              mockupSetInfo(
                "Enter a positive known distance in feet, then click two points again."
              );
            } else {
              feetPerPixel = feet / pixels;
              mockupSetInfo(
                `Scale set: ${feet.toFixed(1)} ft = ${pixels.toFixed(
                  1
                )} pixels. 1 pixel ≈ ${feetPerPixel.toFixed(4)} ft.`
              );
            }
          }
          redrawMockup();
          updateMockupTotals();
         
                } else if (mockupMode === "measure") {
       // Measure and store the run; colors are handled later by the pattern settings
       const runType = mockupRunTypeSelect
         ? mockupRunTypeSelect.value
         : "ridge";

       if (!lastMeasurePoint) {
         lastMeasurePoint = point;
       } else {
         const pixels = pixelDistance(lastMeasurePoint, point);
         const feet = feetPerPixel ? pixels * feetPerPixel : 0; // 0 if no scale yet

         runSegments.push({
           from: lastMeasurePoint,
           to: point,
           feet,
           type: runType,
         });

         lastMeasurePoint = point;
       }

       redrawMockup();
       updateMockupTotals();
     }



      });
    }

    // Apply initial zoom
    applyMockupZoom();

  </script>


  


</body>
</html>
